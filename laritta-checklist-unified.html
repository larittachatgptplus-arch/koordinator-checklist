<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laritta Checklist System</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #D94A38;
            --primary-dark: #B83828;
            --secondary: #2C5F4F;
            --success: #10B981;
            --bg-light: #FAF9F6;
            --bg-white: #FFFFFF;
            --text-dark: #1A1A1A;
            --text-gray: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #FFF5F0 100%);
            color: var(--text-dark);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 32px 20px;
            color: white;
            text-align: center;
            margin-bottom: 32px;
            border-radius: 0 0 24px 24px;
            box-shadow: var(--shadow);
        }
        h1 { font-size: 32px; font-weight: 800; margin-bottom: 8px; }
        .subtitle { opacity: 0.9; font-size: 16px; }
        .login-card, .card {
            background: white;
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            border: 2px solid var(--border);
        }
        .login-card { max-width: 500px; margin: 40px auto; }
        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-dark);
        }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217,74,56,0.1);
        }
        textarea { min-height: 100px; resize: vertical; }
        .form-group { margin-bottom: 20px; }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow);
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .tabs {
            display: flex;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-gray);
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            font-family: inherit;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            border: 2px solid var(--border);
            box-shadow: var(--shadow);
            text-align: center;
        }
        .stat-value {
            font-size: 48px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-gray);
            text-transform: uppercase;
        }
        .coordinator-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-light);
            border-radius: 10px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .coordinator-checkbox:hover { background: #FFE8E3; }
        .coordinator-checkbox input { width: 20px; height: 20px; cursor: pointer; }
        .task-item {
            background: linear-gradient(135deg, #FFF 0%, var(--bg-light) 100%);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin: 12px 0;
            transition: all 0.3s;
        }
        .task-item:hover { border-color: var(--primary); transform: translateX(4px); }
        .task-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin: 4px;
        }
        .badge-priority { background: #FEE2E2; color: #991B1B; }
        .badge-deadline { background: #DBEAFE; color: #1E40AF; }
        .badge-status { background: #D1FAE5; color: #065F46; }
        .badge-pending { background: #FEF3C7; color: #92400E; }
        .badge-progress { background: #FEF3C7; color: #92400E; }
        .badge-progress.complete { background: #D1FAE5; color: #065F46; }
        .welcome {
            background: linear-gradient(135deg, var(--secondary) 0%, #1e4a3c 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
        }
        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            margin: 8px 0;
            background: linear-gradient(135deg, #FFF 0%, var(--bg-light) 100%);
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }
        .store-item.checked {
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
            border-color: var(--success);
        }
        .store-code {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            margin-right: 12px;
        }
        .check-btn {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .check-btn.checked {
            background: var(--success);
            border-color: var(--success);
        }
        .check-btn.checked::after {
            content: '‚úì';
            color: white;
            font-size: 24px;
            font-weight: 700;
        }
        .hidden { display: none !important; }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-gray);
        }
        .role-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 24px;
        }
        .role-card {
            padding: 32px 24px;
            border: 3px solid var(--border);
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .role-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(217,74,56,0.2);
        }
        .role-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .role-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .role-desc {
            font-size: 14px;
            color: var(--text-gray);
        }
        .logout-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: var(--text-gray);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 1000;
        }
        @media (max-width: 768px) {
            .role-selector { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üè™ Laritta Checklist System</h1>
        <div class="subtitle">Koordinator Area Management - Real-Time Sync</div>
    </header>

    <div class="container">
        <!-- Role Selection Screen -->
        <div id="roleSelection">
            <div class="login-card">
                <h2 style="text-align:center;margin-bottom:8px;font-size:24px;">Pilih Role Anda</h2>
                <p style="text-align:center;color:var(--text-gray);margin-bottom:24px;">Silakan pilih untuk melanjutkan</p>
                
                <div class="role-selector">
                    <div class="role-card" onclick="selectRole('manager')">
                        <div class="role-icon">üë®‚Äçüíº</div>
                        <div class="role-title">Manager</div>
                        <div class="role-desc">Assign tugas & monitor</div>
                    </div>
                    <div class="role-card" onclick="selectRole('coordinator')">
                        <div class="role-icon">üë•</div>
                        <div class="role-title">Koordinator Area</div>
                        <div class="role-desc">Checklist tugas toko</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manager Password Screen -->
        <div id="managerPassword" class="hidden">
            <div class="login-card">
                <h2 style="text-align:center;margin-bottom:24px;">üîê Manager Login</h2>
                <form id="passwordForm" onsubmit="return checkPassword(event)">
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="managerPass" placeholder="Masukkan password manager" required>
                    </div>
                    <button type="submit" class="btn btn-primary">üîì Masuk</button>
                    <button type="button" class="btn" style="background:var(--text-gray);color:white;margin-top:12px;" onclick="backToRole()">‚Üê Kembali</button>
                </form>
            </div>
        </div>

        <!-- Coordinator Login Screen -->
        <div id="coordinatorLogin" class="hidden">
            <div class="login-card">
                <h2 style="text-align:center;margin-bottom:24px;">üë• Koordinator Login</h2>
                <div class="form-group">
                    <label>Pilih Nama Anda</label>
                    <select id="coordSelect">
                        <option value="">-- Pilih Nama Anda --</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="coordinatorLogin()">üîì Masuk</button>
                <button class="btn" style="background:var(--text-gray);color:white;margin-top:12px;" onclick="backToRole()">‚Üê Kembali</button>
            </div>
        </div>

        <!-- Manager Interface -->
        <div id="managerInterface" class="hidden">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="tab-btn" onclick="switchTab('assign')">üìù Assign Task</button>
                <button class="tab-btn" onclick="switchTab('tasks')">‚úÖ Tugas Aktif</button>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="mTotalTasks">0</div>
                        <div class="stat-label">Total Tugas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="mCompletedTasks">0</div>
                        <div class="stat-label">Selesai</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="mPendingTasks">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">üìç Status Per Area</div>
                    <div id="areaStats"></div>
                </div>
            </div>

            <div id="assign" class="tab-content">
                <div class="card">
                    <div class="card-title">üìù Buat Tugas Baru</div>
                    <form id="taskForm">
                        <div class="form-group">
                            <label>Judul Tugas *</label>
                            <input type="text" id="taskTitle" required>
                        </div>
                        <div class="form-group">
                            <label>Deskripsi</label>
                            <textarea id="taskDesc"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Kategori</label>
                            <select id="taskCategory">
                                <option>Audio/Visual</option>
                                <option>Display</option>
                                <option>Promo</option>
                                <option>Maintenance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Deadline *</label>
                            <input type="date" id="taskDeadline" required>
                        </div>
                        <div class="form-group">
                            <label>Prioritas</label>
                            <select id="taskPriority">
                                <option>Tinggi</option>
                                <option selected>Sedang</option>
                                <option>Rendah</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Assign ke Koordinator *</label>
                            <div id="coordList"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">‚úÖ Assign Tugas</button>
                    </form>
                </div>
            </div>

            <div id="tasks" class="tab-content">
                <div class="card">
                    <div class="card-title">‚úÖ Tugas Aktif</div>
                    <div id="tasksList"></div>
                </div>
            </div>
        </div>

        <!-- Coordinator Interface -->
        <div id="coordinatorInterface" class="hidden">
            <div class="welcome">
                <h2 id="welcomeName"></h2>
                <p id="welcomeArea"></p>
                <p id="welcomeStores" style="margin-top:4px;font-size:13px;"></p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="cTotalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cCompletedCount">0</div>
                    <div class="stat-label">Selesai</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cPendingCount">0</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchCoordTab('active')">üìã Tugas Aktif</button>
                <button class="tab-btn" onclick="switchCoordTab('history')">üìö Riwayat</button>
            </div>

            <div id="activeTab" class="tab-content active">
                <div id="coordTaskList"></div>
            </div>

            <div id="historyTab" class="tab-content">
                <div id="historyList"></div>
            </div>
        </div>

        <button id="logoutBtn" class="logout-btn hidden" onclick="logout()">üö™ Keluar</button>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC48uhu34bh8JbaocybFeAVbTAhe9PG_2M",
            authDomain: "laritta-checklist-98726.firebaseapp.com",
            databaseURL: "https://laritta-checklist-98726-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laritta-checklist-98726",
            storageBucket: "laritta-checklist-98726.firebasestorage.app",
            messagingSenderId: "814730879474",
            appId: "1:814730879474:web:58d74d8678df4626db4b6b"
        };

        const MANAGER_PASSWORD = "LARITTA1234";
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentRole = null;
        let currentCoord = null;
        let coordinators = [];
        let stores = [];
        let tasks = [];
        let checklists = {};

        // Initialize Firebase data
        async function initializeData() {
            const coordsData = {
                "1": {id:1,name:"Agus Budi Prayitno",area:"Tangerang",phone:"",stores:[1,2,3,4,5,6,7]},
                "2": {id:2,name:"Isa Yuhani",area:"Surabaya Raya",phone:"",stores:[8,9,10,11,12,13,14,15]},
                "3": {id:3,name:"Rosyat Ely Delia",area:"Surabaya Raya",phone:"",stores:[16,17,18,19,20,21,22,23]},
                "4": {id:4,name:"Masita Krismi Adianty",area:"Surabaya Raya",phone:"",stores:[24,25,26,27,28,29,30,31,32]},
                "5": {id:5,name:"Ita Tri Handaynie",area:"Surabaya Raya",phone:"",stores:[33,34,35,36,37,38,39,40]}
            };
            await set(ref(db, 'coordinators'), coordsData);
            
            const storesArr = [
                {id:1,code:"TNG-001",name:"Borobudur - Tangerang"},{id:2,code:"TNG-002",name:"Merdeka - Tangerang"},
                {id:3,code:"TNG-003",name:"Halim - Tangerang"},{id:4,code:"TNG-004",name:"Poris - Tangerang"},
                {id:5,code:"TNG-005",name:"Ciledug - Tangerang"},{id:6,code:"TNG-006",name:"Periuk - Tangerang"},
                {id:7,code:"TNG-007",name:"Graha Raya - Tangerang"},{id:8,code:"SBY-001",name:"Nias"},
                {id:9,code:"SBY-002",name:"Darmahusada"},{id:10,code:"SBY-003",name:"Kutai"},
                {id:11,code:"SBY-004",name:"Barata"},{id:12,code:"SBY-005",name:"Ketintang"},
                {id:13,code:"SBY-006",name:"Menganti - Gresik"},{id:14,code:"SBY-007",name:"Wiyung"},
                {id:15,code:"SBY-008",name:"ST.Gubeng"},{id:16,code:"SBY-009",name:"Gayung Sari"},
                {id:17,code:"SBY-010",name:"Rungkut"},{id:18,code:"SBY-011",name:"Rungkut Tengah"},
                {id:19,code:"SBY-012",name:"Tropodo - Sidoarjo"},{id:20,code:"SBY-013",name:"Deltasari - Sidoarjo"},
                {id:21,code:"SBY-014",name:"Wage"},{id:22,code:"SBY-015",name:"Darmo Permai"},
                {id:23,code:"SBY-016",name:"Manukan"},{id:24,code:"SBY-017",name:"Perak"},
                {id:25,code:"SBY-018",name:"Kapas Krampung"},{id:26,code:"SBY-019",name:"Iskandar Muda"},
                {id:27,code:"SBY-020",name:"Kedung Cowek"},{id:28,code:"SBY-021",name:"Mulyosari"},
                {id:29,code:"SBY-022",name:"Demak"},{id:30,code:"SBY-023",name:"Gresik Kota Baru"},
                {id:31,code:"SBY-024",name:"Panglima Sudirman - Gresik"},{id:32,code:"MDR-001",name:"Bangkalan - Madura"},
                {id:33,code:"SBY-025",name:"Krian - Sidoarjo"},{id:34,code:"SBY-026",name:"Sepanjang - Sidoarjo"},
                {id:35,code:"SBY-027",name:"Dukuh Kupang"},{id:36,code:"SBY-028",name:"Diponegoro - Sidoarjo"},
                {id:37,code:"SBY-029",name:"Cemengkalang"},{id:38,code:"SBY-030",name:"Sukodono"},
                {id:39,code:"SBY-031",name:"Candi - Sidoarjo"},{id:40,code:"SBY-032",name:"Tanggulangin"}
            ];
            const storesData = {};
            storesArr.forEach(s => storesData[s.id] = s);
            await set(ref(db, 'stores'), storesData);
            console.log('‚úÖ Data initialized');
        }

        // Load data
        onValue(ref(db, 'coordinators'), (snapshot) => {
            coordinators = snapshot.val() ? Object.values(snapshot.val()) : [];
            if (coordinators.length === 0) initializeData();
            else {
                const select = document.getElementById('coordSelect');
                select.innerHTML = '<option value="">-- Pilih Nama Anda --</option>' +
                    coordinators.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                renderCoordList();
            }
        });

        onValue(ref(db, 'stores'), (snapshot) => {
            stores = snapshot.val() ? Object.values(snapshot.val()) : [];
        });

        onValue(ref(db, 'tasks'), (snapshot) => {
            tasks = snapshot.val() ? Object.entries(snapshot.val()).map(([key, val]) => ({...val, firebaseKey: key})) : [];
            if (currentRole === 'manager') updateManagerDashboard();
            if (currentRole === 'coordinator' && currentCoord) renderCoordTasks();
        });

        onValue(ref(db, 'checklists'), (snapshot) => {
            checklists = snapshot.val() || {};
            if (currentRole === 'coordinator' && currentCoord) renderCoordTasks();
        });

        // Role selection
        window.selectRole = function(role) {
            if (role === 'manager') {
                document.getElementById('roleSelection').classList.add('hidden');
                document.getElementById('managerPassword').classList.remove('hidden');
            } else {
                document.getElementById('roleSelection').classList.add('hidden');
                document.getElementById('coordinatorLogin').classList.remove('hidden');
            }
        };

        window.backToRole = function() {
            document.getElementById('managerPassword').classList.add('hidden');
            document.getElementById('coordinatorLogin').classList.add('hidden');
            document.getElementById('roleSelection').classList.remove('hidden');
            document.getElementById('managerPass').value = '';
        };

        window.checkPassword = function(e) {
            e.preventDefault();
            const pass = document.getElementById('managerPass').value;
            if (pass === MANAGER_PASSWORD) {
                currentRole = 'manager';
                sessionStorage.setItem('role', 'manager');
                document.getElementById('managerPassword').classList.add('hidden');
                document.getElementById('managerInterface').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                updateManagerDashboard();
            } else {
                alert('‚ùå Password salah!');
            }
            return false;
        };

        window.coordinatorLogin = function() {
            const id = parseInt(document.getElementById('coordSelect').value);
            if (!id) { alert('Pilih nama Anda!'); return; }
            
            currentCoord = coordinators.find(c => c.id === id);
            currentRole = 'coordinator';
            sessionStorage.setItem('role', 'coordinator');
            sessionStorage.setItem('coordId', id);
            
            document.getElementById('coordinatorLogin').classList.add('hidden');
            document.getElementById('coordinatorInterface').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            
            document.getElementById('welcomeName').textContent = `Halo, ${currentCoord.name}! üëã`;
            document.getElementById('welcomeArea').textContent = `Area: ${currentCoord.area}`;
            document.getElementById('welcomeStores').textContent = `Anda mengelola ${currentCoord.stores?.length || 0} toko`;
            
            renderCoordTasks();
        };

        window.logout = function() {
            sessionStorage.clear();
            location.reload();
        };

        // Manager functions
        function renderCoordList() {
            const list = document.getElementById('coordList');
            list.innerHTML = coordinators.map(c => `
                <label class="coordinator-checkbox">
                    <input type="checkbox" name="coord" value="${c.id}">
                    <span><strong>${c.name}</strong> - ${c.area}</span>
                </label>
            `).join('');
        }

        function updateManagerDashboard() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.coordinators && t.coordinators.every(c => c.checked)).length;
            
            document.getElementById('mTotalTasks').textContent = total;
            document.getElementById('mCompletedTasks').textContent = completed;
            document.getElementById('mPendingTasks').textContent = total - completed;

            const statsHtml = coordinators.map(coord => {
                const coordTasks = tasks.filter(t => t.coordinators && t.coordinators.some(c => c.id === coord.id));
                const coordCompleted = coordTasks.filter(t => {
                    const cData = t.coordinators.find(c => c.id === coord.id);
                    return cData && cData.checked;
                }).length;

                return `
                    <div style="padding:16px;margin:8px 0;background:var(--bg-light);border-radius:12px;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <strong>${coord.name}</strong><br>
                            <span style="font-size:13px;color:var(--text-gray)">${coord.area} - ${coord.stores?.length || 0} toko</span>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <span class="badge badge-status">${coordCompleted} Selesai</span>
                            <span class="badge badge-pending">${coordTasks.length - coordCompleted} Pending</span>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('areaStats').innerHTML = statsHtml || '<div class="empty-state">Belum ada data</div>';

            renderManagerTasks();
        }

        function renderManagerTasks() {
            const list = document.getElementById('tasksList');
            if (tasks.length === 0) {
                list.innerHTML = '<div class="empty-state">Belum ada tugas</div>';
                return;
            }

            list.innerHTML = tasks.map(task => {
                const completed = task.coordinators ? task.coordinators.filter(c => c.checked).length : 0;
                const total = task.coordinators ? task.coordinators.length : 0;
                
                return `
                    <div class="task-item">
                        <div class="task-title">${task.title}</div>
                        <div>
                            <span class="badge badge-priority">${task.priority}</span>
                            <span class="badge badge-deadline">‚è∞ ${task.deadline}</span>
                            <span class="badge ${completed === total ? 'badge-status' : 'badge-pending'}">${completed}/${total} Koordinator</span>
                        </div>
                        <div style="margin-top:12px;">
                            ${task.coordinators ? task.coordinators.map(c => `
                                <div style="padding:8px;margin:4px 0;background:white;border-radius:8px;display:flex;justify-content:space-between;">
                                    <span>${c.name}</span>
                                    <span>${c.checked ? '‚úÖ Selesai' : '‚è≥ Pending'}</span>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedCoords = Array.from(document.querySelectorAll('input[name="coord"]:checked'))
                .map(cb => coordinators.find(c => c.id === parseInt(cb.value)));

            if (selectedCoords.length === 0) {
                alert('Pilih minimal 1 koordinator!');
                return;
            }

            const task = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDesc').value,
                category: document.getElementById('taskCategory').value,
                deadline: document.getElementById('taskDeadline').value,
                priority: document.getElementById('taskPriority').value,
                createdAt: new Date().toISOString(),
                coordinators: selectedCoords.map(c => ({
                    id: c.id,
                    name: c.name,
                    area: c.area,
                    checked: false,
                    checkedAt: null
                }))
            };

            await push(ref(db, 'tasks'), task);
            alert('‚úÖ Tugas berhasil di-assign!');
            e.target.reset();
        });

        window.switchTab = function(tab) {
            document.querySelectorAll('#managerInterface .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#managerInterface .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        };

        // Coordinator functions
        function renderCoordTasks() {
            const myTasks = tasks.filter(t => t.coordinators && t.coordinators.some(c => c.id === currentCoord.id));
            const list = document.getElementById('coordTaskList');
            
            if (myTasks.length === 0) {
                list.innerHTML = '<div class="empty-state">üìã<br>Belum ada tugas</div>';
                updateCoordStats(0, 0);
                return;
            }

            let completed = 0;
            list.innerHTML = myTasks.map(task => {
                const myStores = stores.filter(s => currentCoord.stores?.includes(s.id));
                let checkedCount = 0;
                
                const storesHtml = myStores.map(store => {
                    const checkKey = `${task.firebaseKey}_${currentCoord.id}_${store.id}`;
                    const isChecked = checklists[checkKey]?.checked || false;
                    if (isChecked) checkedCount++;
                    
                    return `
                        <div class="store-item ${isChecked ? 'checked' : ''}">
                            <div style="display:flex;align-items:center;flex:1;">
                                <span class="store-code">${store.code}</span>
                                <div>
                                    <div style="font-weight:600;">${store.name}</div>
                                    ${isChecked ? `<div style="font-size:11px;color:var(--success);">‚úì ${formatTime(checklists[checkKey].time)}</div>` : ''}
                                </div>
                            </div>
                            <div class="check-btn ${isChecked ? 'checked' : ''}" onclick="toggleCheck('${task.firebaseKey}', ${store.id})"></div>
                        </div>
                    `;
                }).join('');

                const allChecked = checkedCount === myStores.length && myStores.length > 0;
                if (allChecked) completed++;

                return `
                    <div class="card">
                        <div class="task-title">${task.title}</div>
                        <div>
                            <span class="badge badge-priority">${task.priority}</span>
                            <span class="badge badge-deadline">‚è∞ ${task.deadline}</span>
                            <span class="badge badge-progress ${allChecked ? 'complete' : ''}">${checkedCount}/${myStores.length} Toko</span>
                        </div>
                        ${task.description ? `<p style="color:var(--text-gray);margin:16px 0;">${task.description}</p>` : ''}
                        <div style="margin-top:20px;">
                            <div style="font-weight:700;margin-bottom:12px;">üè™ Checklist Toko (${checkedCount}/${myStores.length})</div>
                            ${storesHtml}
                        </div>
                    </div>
                `;
            }).join('');

            updateCoordStats(myTasks.length, completed);
        }

        window.toggleCheck = async function(taskKey, storeId) {
            const checkKey = `${taskKey}_${currentCoord.id}_${storeId}`;
            const current = checklists[checkKey]?.checked || false;
            
            await update(ref(db, `checklists/${checkKey}`), {
                checked: !current,
                time: new Date().toISOString(),
                coordId: currentCoord.id,
                taskKey: taskKey,
                storeId: storeId
            });

            const task = tasks.find(t => t.firebaseKey === taskKey);
            if (task) {
                const myStores = stores.filter(s => currentCoord.stores?.includes(s.id));
                let allChecked = true;
                for (let store of myStores) {
                    const key = `${taskKey}_${currentCoord.id}_${store.id}`;
                    if (key === checkKey) {
                        if (current) allChecked = false;
                    } else {
                        if (!checklists[key]?.checked) allChecked = false;
                    }
                }

                const coordIdx = task.coordinators.findIndex(c => c.id === currentCoord.id);
                if (coordIdx !== -1) {
                    const updates = {};
                    updates[`tasks/${taskKey}/coordinators/${coordIdx}/checked`] = allChecked;
                    updates[`tasks/${taskKey}/coordinators/${coordIdx}/checkedAt`] = allChecked ? new Date().toISOString() : null;
                    await update(ref(db), updates);
                }
            }
        };

        window.switchCoordTab = function(tab) {
            document.querySelectorAll('#coordinatorInterface .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#coordinatorInterface .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            event.target.classList.add('active');
            if (tab === 'history') renderHistory();
        };

        function renderHistory() {
            const myTasks = tasks.filter(t => t.coordinators && t.coordinators.some(c => c.id === currentCoord.id));
            const completedTasks = myTasks.filter(task => {
                const myStores = stores.filter(s => currentCoord.stores?.includes(s.id));
                return myStores.every(store => {
                    const key = `${task.firebaseKey}_${currentCoord.id}_${store.id}`;
                    return checklists[key]?.checked;
                }) && myStores.length > 0;
            });

            const list = document.getElementById('historyList');
            if (completedTasks.length === 0) {
                list.innerHTML = '<div class="empty-state">üìö<br>Belum ada riwayat</div>';
                return;
            }

            list.innerHTML = completedTasks.map(task => {
                const myStores = stores.filter(s => currentCoord.stores?.includes(s.id));
                return `
                    <div class="card" style="border-color:var(--success);background:linear-gradient(135deg,#F0FDF4,#DCFCE7);">
                        <div class="task-title">${task.title}</div>
                        <span class="badge badge-progress complete">‚úÖ Selesai</span>
                        <div style="margin-top:16px;padding:16px;background:white;border-radius:12px;">
                            <div style="font-weight:600;margin-bottom:8px;">üè™ Toko Selesai (${myStores.length})</div>
                            ${myStores.map(store => {
                                const key = `${task.firebaseKey}_${currentCoord.id}_${store.id}`;
                                return `<div style="padding:8px;margin:4px 0;background:var(--bg-light);border-radius:8px;display:flex;justify-content:space-between;">
                                    <span><span class="store-code" style="font-size:11px;padding:4px 8px;">${store.code}</span> ${store.name}</span>
                                    <span style="font-size:11px;color:var(--success);">‚úì ${formatTime(checklists[key].time)}</span>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCoordStats(total, completed) {
            document.getElementById('cTotalCount').textContent = total;
            document.getElementById('cCompletedCount').textContent = completed;
            document.getElementById('cPendingCount').textContent = total - completed;
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString('id-ID', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
        }

        // Check session
        const savedRole = sessionStorage.getItem('role');
        if (savedRole === 'manager') {
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('managerInterface').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            currentRole = 'manager';
        } else if (savedRole === 'coordinator') {
            const savedId = parseInt(sessionStorage.getItem('coordId'));
            if (savedId) {
                setTimeout(() => {
                    document.getElementById('coordSelect').value = savedId;
                    coordinatorLogin();
                }, 500);
            }
        }

        document.getElementById('taskDeadline').min = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
